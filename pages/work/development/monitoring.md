# 監視
## TL;DR
- 監視について考えたことやそのコンポーネントの整理

## 監視とは
### 定義
監視とは、あるシステムやそのシステムのコンポーネントの振る舞いや出力を観察しチェックし続ける行為である

### 目的
- **監視は質問を投げかけるためにある** - Deve Josephsen, Monitorama 2016

## 対象
### コードレベル
- StatsDツール

### アプリケーション品質
- APM(Application Perfomance Monitoring)ツール

### チーム品質
- Github, JIRA, Slack, esa

## 監視サービスのコンポーネント
### データ収集
#### プル型
- 監視対象となるホストにエージェントをインストール、各ホストのエージェントが監視サーバに対してデータを送信する
- 事例: StatsD, Sensu, Datadog, Meckerel
- メリット
    - 監視対象を増やす場合はエージェントをインストールするだけで簡易
    - Pull型と比較して監視対象が外からアクセスを受けるための設定が不要
- デメリット
    - 監視対象が増えた時に監視サーバに負荷が集中

#### プッシュ型
- 監視サーバ上に監視対象についての設定を行い、監視対象からデータを集めてくる
- 事例: Nagios, Zabbix, Prometheus
- メリット
    - 監視対象一覧を把握しているため、データを取得出来なかった場合に異常に気づける
    - 監視サーバの負荷が高まった場合に柔軟な対応がとりやすい
- デメリット
    - データをexposeするためのエージェントも各ホストで準備する必要がある
    - AutoScaling 等で監視対象の数が変更した場合に、監視対象リストをアップデートする必要がある

#### 最近はPush型→Pull型
以前は監視サーバに設定ファイルを設置して、ホストの監視を行うPush型が一般的だった。  
だが、IaaSなどのクラウドサービスが一般的になり、監視対象が動的に変わる環境では設定ファイルをアップデートしていく仕組みを作る必要性が出てくるなど辛い部分が出てきた。  
監視対象からメトリクスデータなどを送ってもらう Push型のアプローチが注目を集め、クラウドサービスを利用する場合はPull型が一般的になった。

#### メトリクス
- Counter: 増加していくメトリクス
- Guage: ある時点の値

#### ログ
- 連続した文字列のことで、(可能なら)いつイベントが発生したのかを示すタイムスタンプが関連づけられたもの
- 構造化ログ: JSONとか
- 非構造化ログ: 各フィールドに明確な意味のマッピングがない。順序が意味を持つ場合がよくある

### データストレージ
- 時系列データベース(Time Series Database)
    - RRD(Round Robin Database)
    - Graphite
    - Whisper
    - 一定期間後に「間引き(roll up)」や「有効期限切れ(age out)」が発生する
### 可視化
- モノシリックなツール(NagiosやSolarWinds NPM)などを使用している場合は付属のダッシュボードがある
- BIツール
    - Re:dash
    - Graphana
- 可視化の話は考えうる要素がたくさん。参考書はこちら。(気が向いたらまとめる)
    - 「The Visual Display of Quantitative Information」(Edward Tufte)
    - 「Information Dashboard Dsesign」(Stephen Few)
- ソフトウェアエンジニアリングにおいて円グラフは使わない[余談]
    - 円グラフの主な目的は、ある時点での状態の可視化
    - 円グラフには過程やトレンドといった情報が含まれていないため、あまり変化しない値を表示するのに向いている
    - データを全体との関連で表現するのに利用されることが多いが、棒グラフの方が良い可視化である場合が多い。
- 最高のダッシュボードは１つのサービスあるいは１つのプロダクトのステータス表示に焦点を絞ることが重要

### 分析とレポート
SLAを決定してレポートする

### アラート
収集しているメトリクスやグラフはアラートと１体１対応している必要はない。監視はアラートを出すために存在するのではない、アラートは結果の１つ

- 誰かを叩き起こすためのアラート
- 参考情報(FYI)としてのアラート

#### オンコール
- Follow-the-sun(FTS)ローテーション
- PagerDuty、VictorOps, OpsGenie
- オンコールに対する補償
    - オンコールシフトの直後に、有給と１日取らせる。オンコール担当は神経を使う仕事であり、回復のための日は確保する価値がある
    - オンコールシフトごとに手当を払う。オンコールシフトのたびに手当を支払うのは医療業界では一般的なこと。

## インシデント管理
予定していないITサービスの中断、または、ITサービス品質の低下。

### インシデント管理のプロセス
- インシデントの認識
- インシデントのロギング
- インシデントの分類
- インシデントの優先順位付け
- インシデント初期診断
- 必要に応じたレベル２サポートへのエスカレーション
- インシデントの解決
- インシデントのクローズ
- インシデント発生中におけるユーザコミュニティとのコミュニケーション

### 役割
- 現場指揮官(Incident commander)
    - サービス停止に関する調査を監督する役割
    - 改善、顧客や社内とのコミュニケーション、調査には関わらない
- スクライブ(Scribe)
    - 起こったことを記録する
- コミュニケーション調整役
    - 社内外とわず利害関係者に最新の状況のコミュニケーションを取る
- SME(Subject matter expert)
    - 実際にインシデント対応する人
    
## 参照
- [入門 監視](https://www.oreilly.co.jp/books/9784873118642/)
- [PagerDuty インシデント対応](https://response.pagerduty.com/)
